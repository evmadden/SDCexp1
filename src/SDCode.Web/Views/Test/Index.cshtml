@model SDCode.Web.Models.TestImmediateViewModel
@{
    ViewData["Title"] = "Test";
}
<script>
    document.addEventListener("DOMContentLoaded", function(){
        var imageElement = document.getElementById('image');
        var showImage = function(url, progress) {
            imageElement.setAttribute('data-progress', progress);
            imageElement.src = url;
        }
        var sendResponse = function() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '@Url.Action("ResponseData")', true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(this.response);
                    if (response.testEnded) {
                        imageElement.style.display = 'none';
                        document.getElementById(`${response.testEnded.toLowerCase()}Ended`).style.display = 'block';
                    } else {
                        showImage(response.viewModel.imageUrl, response.viewModel.progress);
                    }
                }
            }
            var progress = imageElement.getAttribute('data-progress');
            xhr.send(`participantID=@Model.ParticipantID&progress=${progress}`);
        };
        imageElement.onload = function() { 
            imageElement.style.display = 'block';
            setTimeout(sendResponse, 1000);
        };
        showImage('@Model.ImageUrl', @Model.Progress)
    });
</script>
<div style="vertical-align: top; text-align: center;">
    <img id="image" style="display: none; width: 800px; height: 700px;"/>
    <div id="immediateEnded" style="display: none;">IMMEDIATE_FINISHED_PLACEHOLDER</div>
    <div id="delayedEnded" style="display: none;">DELAYED_FINISHED_PLACEHOLDER</div>
    <div id="followupEnded" style="display: none;">FOLLOWUP_FINISHED_PLACEHOLDER</div>
</div>


<div id="formDiv">
    <form action="/Test/Finished" method="post"> 
        <input type="hidden" name="participantID" value="@Model.ParticipantID" />
    </form>
</div>